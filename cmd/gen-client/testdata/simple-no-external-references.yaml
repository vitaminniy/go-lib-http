openapi: 3.0.0
info:
  title: VendorSearch service
  version: 1.0.0

servers:
  - url: https://vendor-search.hungerstation.com
    description: production
  - url: https://vendor-search.hs-staging.com
    description: staging

paths:
  /api/v2/vendors:
    post:
      summary: >-
        Returns vendors available for given coordinates and optional filters.
      security:
        - AuthyJWT: []
      parameters:
        - $ref: '#/components/parameters/UserAgent'
        - $ref: '#/components/parameters/AcceptLanguage'
        - $ref: '#/components/parameters/PerseusClientId'
        - $ref: '#/components/parameters/PerseusSessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VendorsRequestBody'
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VendorsResponseBody'
        400:
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        500:
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    AuthyJWT:
      type: http
      description: >-
        JWT Authentication.
        TODO(max): make common for all endpoints; x-hs-middleware maybe?
      scheme: bearer
      bearerFormat: JWT

  parameters:
    UserAgent:
      in: header
      name: User-Agent
      description: >
        The User-Agent request header is a characteristic string that lets servers
        and network peers identify the application, operating system, vendor, and/or
        version of the requesting user agent.

      required: true
      schema:
        type: string

    AcceptLanguage:
      in: header
      name: Accept-Language
      description: >
        The Accept-Language request HTTP header indicates the natural language and
        locale that the client prefers.

      required: false
      schema:
        type: string
        default: en-US

    PerseusClientId:
      in: header
      name: perseus-client-id
      required: false
      schema:
        type: string

    PerseusSessionId:
      in: header
      name: perseus-session-id
      required: false
      schema:
        type: string

  schemas:
    VendorsRequestBody:
      type: object
      required:
        - location
        - pagination
      properties:
        home_module_id:
          $ref: "#/components/schemas/HomeModuleId"
        location:
          $ref: '#/components/schemas/Location'
        pagination:
          $ref: '#/components/schemas/RequestPagination'
        sorting_key:
          type: string
          description: >-
            Sorting's key to apply on available vendors.

            NOTE: currently possible values are
              - DEFAULT
              - DISTANCE_CLOSEST
              - RATING
              - FASTEST_DELIVERY

            Not specifying as enum to have flexibility to change them later.
          example: DEFAULT
        filters:
          type: array
          description: Custom filters applied on available vendors.
          items:
            $ref: '#/components/schemas/RequestFilter'
      additionalProperties: false

    HomeModuleId:
      type: integer
      description: Home Module ID.
      format: int64
      minimum: 1

    Location:
      type: object
      description: Location represent coordinate-pair.
      required:
        - latitude
        - longitude
        - landmark
      properties:
        latitude:
          description: >
            The latitude shows the angle between the straight line in the certain
            point and the equatorial plane. The latitude is specified by degrees,
            starting from 0° and ending up with 90° to both sides of the equator,
            making latitude Northern and Southern. The equator is the line with 0°
            latitude.

          type: number
          format: double
          minimum: -90
          maximum: 90
          example: 24.8273728
        longitude:
          description: >
            The longitude is defined as an angle pointing west or east from the Greenwich
            Meridian, which is taken as the Prime Meridian. The longitude can be defined
            maximum as 180° east from the Prime Meridian and 180° west from the Prime
            Meridian.

            @See: prime meridian https://www.latlong.net/place/prime-meridian-greenwich-30835.html

          type: number
          format: double
          minimum: -180
          maximum: 180
          example: 46.6387378
        landmark:
          description: >
            landmark identifying the location of this vendor's branch.
            Field is localized, and can be used for display purposes.
            If the landmark is not available, then the local name will
            be returned instead. Optional.

          type: string
          example: "One Square"
      additionalProperties: false

    RequestPagination:
      type: object
      description: Request pagination settings.
      properties:
        limit:
          type: integer
          description: "Controls maximum number of elements that can be returned in
            a\nresponse. \n"
          format: int64
          minimum: 1
          default: 50
        page:
          type: integer
          description: >
            Sets page number. Skips `limit` objects for each page subsequent page.

          format: int64
          minimum: 1
          default: 1
      additionalProperties: false

    RequestFilter:
      type: object
      description: Custom filter applied on available vendors.
      required:
        - type
        - ids
      properties:
        type:
          type: string
          description: >-
            Filter's type.
            - kitchen_ids for category filters
            - vertical_keys for filter for verticals; overrides home module ID
            - filter_options for custom filters
          enum:
            - kitchen_ids
            - vertical_keys
            - filter_options
          example: filter_options
        ids:
          type: array
          description: Filter's values.
          items:
            type: string
          example:
            - rating__4.5
            - is_top__true
      additionalProperties: false

    VendorsResponseBody:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          description: List of vendors suitable for given request.
          items:
            $ref: '#/components/schemas/Vendor'
        pagination:
          $ref: '#/components/schemas/ResponsePagination'
      additionalProperties: false

    Vendor:
      type: object
      description: Vendor defines an entity fo presenting a vendor object.
      required:
        - id
        - chain_id
        - chain_name
        - logo
        - cover_photo
        - kitchens
        - average_rating
        - rate_count
        - vertical
        - status
        - minimum_order
        - location
        - filtered_count
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        external_id:
          type: string
        chain_id:
          type: integer
          format: int64
          minimum: 0
        chain_name:
          type: string
        brand_id:
          type: integer
          format: int64
          minimum: 0
        logo:
          type: string
          description: >
            Vendor's logo.

            NOTE(max): go-code has `driver.Value` but actual vss response has `string`.
            Decided to go with string.

        cover_photo:
          type: string
          description: >
            Vendor's cover photo.

            NOTE(max): go-code has `driver.Value` but actual vss response has `string`.
            Decided to go with string.

        kitchens:
          type: array
          items:
            type: string
        average_rating:
          type: string
        rate_count:
          type: integer
          minimum: 0
        vertical:
          type: string
        status:
          type: string
        minimum_order:
          type: string
        promotions:
          type: array
          items:
            $ref: '#/components/schemas/Promotion'
        location:
          $ref: '#/components/schemas/Location'
        filtered_count:
          type: integer
          minimum: 0
      additionalProperties: false

    Promotion:
      type: object
      required:
        - name
        - type
        - icon_url
        - minimum_order
      properties:
        name:
          type: string
        type:
          type: string
        icon_url:
          type: string
        minimum_order:
          type: string
        category:
          type: string
          enum:
            - RED
            - BLUE
          example: RED
      additionalProperties: false

    ResponsePagination:
      type: object
      description: Request pagination settings.
      required:
        - limit
        - page
        - total
        - total_count
      properties:
        limit:
          type: integer
          description: >
            Controls maximum number of elements that can be returned in a response.

          format: int64
          minimum: 1
        page:
          type: integer
          description: >
            Sets page number. Skips `limit` objects for each page subsequent page.

          format: int64
          minimum: 1
        total:
          type: integer
          description: Number of available pages.
          format: int64
          minimum: 0
        total_count:
          type: integer
          description: Number of available objects.
          format: int64
          minimum: 0
      additionalProperties: false

    ErrorResponse:
      type: object
      description: >
        JSON-RPC error response.

        @See: https://jsonapi.org/format/#error-objects

      required:
        - errors
      properties:
        errors:
          type: array
          items:
            $ref: '#/components/schemas/Error'
      additionalProperties: false

    Error:
      type: object
      description: >
        JSON-RPC error object.

        @See: https://jsonapi.org/format/#error-objects

      required:
        - status
        - title
      properties:
        status:
          type: integer
          minimum: 0
          description: >
            The HTTP status code applicable to this problem.

            @NOTE: JSON API expresses this value as a string.

        title:
          type: string
          description: >
            A short, human-readable summary of the problem that SHOULD NOT change
            from occurrence to occurrence of the problem, except for purposes of localization.

        detail:
          type: string
          description: >
            A human-readable explanation specific to this occurrence of the problem.
            Like `title`, this field’s value can be localized.

      additionalProperties: false

